---
const { data, width = 800, height = 360, padding = 50 } = Astro.props;

// Auto-detect symbols
const symbols = Object.keys(data[0] ?? {}).filter((k) => k !== "date");

// Assign colors (portfolio average in black)
const palette = ["#111827", "#2563eb", "#16a34a", "#9333ea", "#059669", "#f59e0b", "#dc2626"];
const colors = Object.fromEntries(
  symbols.map((s, i) => [s, s === "PORTFOLIO_AVG" ? "#000000" : palette[i % palette.length]])
);

const dates = data.map((d) => d.date);
const allValues = data.flatMap(d => symbols.map(s => Number(d[s] ?? 0)));
const minY = Math.min(...allValues);
const maxY = Math.max(...allValues);

// Add a small padding so lines don't touch top/bottom
const yPadding = (maxY - minY) * 0.05;
const minYPadded = minY - yPadding;
const maxYPadded = maxY + yPadding;

const xScale = (i) => padding + (i / (dates.length - 1)) * (width - padding * 2);
const yScale = (v) => height - padding - ((v - minYPadded) / (maxYPadded - minYPadded)) * (height - padding * 2);

const linePath = (symbol) =>
  data.map((d, i) => `${i === 0 ? "M" : "L"} ${xScale(i)} ${yScale(d[symbol])}`).join(" ");
---

<div class="w-full overflow-hidden">
  <svg id="portfolio-chart" viewBox={`0 0 ${width} ${height}`} preserveAspectRatio="xMidYMid meet" class="w-full h-auto" role="img" aria-label="Portfolio performance chart">

    <style>
      .chart-line { transition: opacity 0.2s, stroke-width 0.2s; opacity: 0.3; }
      .chart-line.active { opacity: 1; stroke-width: 3; }
      .portfolio-line { stroke-width: 4; opacity: 0.6; }
      .portfolio-line.active { stroke-width: 5; opacity: 1; }
    </style>

    <!-- Axes -->
    <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#e5e7eb" />
    <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#e5e7eb" />

    <!-- Y-axis labels -->
    {[minY, (minY + maxY)/2, maxY].map(v => (
      <g>
        <text x={padding-10} y={yScale(v)+4} text-anchor="end" font-size="11" fill="#6b7280">{v.toFixed(0)}%</text>
        <line x1={padding} x2={width-padding} y1={yScale(v)} y2={yScale(v)} stroke="#f3f4f6" />
      </g>
    ))}

    <!-- Lines -->
    {symbols.map(symbol => (
      <g key={symbol}>
        <path
          d={linePath(symbol)}
          fill="none"
          stroke={colors[symbol]}
          class={symbol === "PORTFOLIO_AVG" ? "portfolio-line" : "chart-line"}
          data-symbol={symbol}
        />

        {data.map((d, i) => (
          <circle
            cx={xScale(i)}
            cy={yScale(d[symbol])}
            r={6}
            fill="transparent"
          >
            <title>{`${symbol === "PORTFOLIO_AVG" ? "Portfolio Avg" : symbol}: ${d[symbol].toFixed(2)}%`}</title>
          </circle>
        ))}
      </g>
    ))}
  </svg>

  <!-- Legend -->
  <div class="flex flex-wrap gap-4 mt-3 overflow-x-auto">
    {symbols.map(symbol => (
      <div class="flex items-center gap-2 text-xs sm:text-sm cursor-pointer" key={symbol} data-symbol={symbol}>
        <span class="w-3 h-3 rounded-full flex-shrink-0" style={`background-color: ${colors[symbol]}`}></span>
        <span class={symbol === "PORTFOLIO_AVG" ? "font-semibold truncate max-w-[120px]" : "font-medium truncate max-w-[120px]"}>
          {symbol === "PORTFOLIO_AVG" ? "Portfolio Avg" : symbol}
        </span>
      </div>
    ))}
  </div>
</div>

<script is:inline>
  const chart = document.getElementById('portfolio-chart');
  const lines = chart.querySelectorAll('path[data-symbol]');
  const legendItems = document.querySelectorAll('[data-symbol]');

  function setActive(symbol) {
    lines.forEach(l => {
      if (l.dataset.symbol === symbol) l.classList.add('active');
      else l.classList.remove('active');
    });
  }

  legendItems.forEach(item => {
    const sym = item.dataset.symbol;
    item.addEventListener('click', () => setActive(sym));
    item.addEventListener('mouseover', () => setActive(sym));
    item.addEventListener('mouseout', () => lines.forEach(l => l.classList.remove('active')));
  });
</script>