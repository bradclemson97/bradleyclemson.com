---
const { data, width = 800, height = 360, padding = 50 } = Astro.props;

// Auto-detect symbols
const symbols = Object.keys(data[0] ?? {}).filter((k) => k !== "date");

// Color palette
const palette = [
  "#2563eb",
  "#16a34a",
  "#9333ea",
  "#059669",
  "#f59e0b",
  "#dc2626",
  "#0ea5e9",
];

const colors = Object.fromEntries(
  symbols.map((s, i) => [
    s,
    s === "PORTFOLIO_AVG" ? "#000000" : palette[i % palette.length],
  ])
);

const dates = data.map((d) => d.date);
const allValues = data.flatMap((d) =>
  symbols.map((s) => Number(d[s] ?? 0))
);

const minY = Math.min(...allValues);
const maxY = Math.max(...allValues);

// Pad Y range
const yPadding = (maxY - minY) * 0.05;
const minYPadded = minY - yPadding;
const maxYPadded = maxY + yPadding;

const xScale = (i) =>
  padding + (i / (dates.length - 1)) * (width - padding * 2);

const yScale = (v) =>
  height -
  padding -
  ((v - minYPadded) / (maxYPadded - minYPadded)) *
    (height - padding * 2);

const linePath = (symbol) =>
  data
    .map(
      (d, i) =>
        `${i === 0 ? "M" : "L"} ${xScale(i)} ${yScale(d[symbol])}`
    )
    .join(" ");

// Last-point helpers
const lastIndex = data.length - 1;
const lastX = xScale(lastIndex);

// Last-value badges
const BADGE_WIDTH = 56;
const BADGE_HEIGHT = 20;
const BADGE_OFFSET = 8;
---

<div class="w-full overflow-hidden relative">
  <svg
    viewBox={`0 0 ${width} ${height}`}
    preserveAspectRatio="xMidYMid meet"
    class="w-full h-auto"
  >
    <style>
      .chart-line {
        opacity: 0.6;
        transition: opacity 0.2s ease, stroke-width 0.2s ease;
      }

      .portfolio-line {
        opacity: 0.8;
        stroke-width: 4;
      }

      .value-badge {
        display: none;
        pointer-events: none;
      }
    </style>

    <!-- Axes -->
    <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#e5e7eb" />
    <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#e5e7eb" />

    <!-- Y-axis labels + grid -->
    {[minY, (minY + maxY) / 2, maxY].map((v) => (
      <g>
        <text
          x={padding - 10}
          y={yScale(v) + 4}
          text-anchor="end"
          font-size="11"
          fill="#6b7280"
        >
          {v.toFixed(0)}%
        </text>
        <line
          x1={padding}
          x2={width - padding}
          y1={yScale(v)}
          y2={yScale(v)}
          stroke="#f3f4f6"
        />
      </g>
    ))}

    <!-- Lines -->
    {symbols.map((symbol) => (
      <path
        d={linePath(symbol)}
        fill="none"
        stroke={colors[symbol]}
        data-symbol={symbol}
        class={`chart-line ${
          symbol === "PORTFOLIO_AVG" ? "portfolio-line" : ""
        }`}
        stroke-width={symbol === "PORTFOLIO_AVG" ? 4 : 2}
      />
    ))}

    <!-- Last value badges -->
    {symbols.map((symbol) => {
      const lastValue = Number(data[lastIndex][symbol] ?? 0);
      const y = yScale(lastValue);

      // Flip badge left if it would overflow right edge
      const flipLeft =
        lastX + BADGE_OFFSET + BADGE_WIDTH > width - padding;

      const badgeX = flipLeft
        ? lastX - BADGE_OFFSET - BADGE_WIDTH
        : lastX + BADGE_OFFSET;

      const textX = badgeX + BADGE_WIDTH / 2;

      return (
        <g class="value-badge" data-symbol={symbol}>
          <!-- Point -->
          <circle
            cx={lastX}
            cy={y}
            r="4"
            fill={colors[symbol]}
          />

          <!-- Badge background -->
          <rect
            x={badgeX}
            y={y - BADGE_HEIGHT / 2}
            rx="4"
            ry="4"
            width={BADGE_WIDTH}
            height={BADGE_HEIGHT}
            fill="white"
            stroke="#e5e7eb"
          />

          <!-- Badge text -->
          <text
            x={textX}
            y={y + 4}
            text-anchor="middle"
            font-size="11"
            fill="#111827"
            font-weight="600"
          >
            {lastValue.toFixed(1)}%
          </text>
        </g>
      );
    })}
  </svg>

  <!-- Legend -->
  <div class="flex flex-wrap gap-4 mt-3 overflow-x-auto">
    {symbols.map((symbol) => (
      <div
        class="legend-item flex items-center gap-2 text-xs sm:text-sm cursor-pointer select-none opacity-70 hover:opacity-100 transition-opacity"
        data-symbol={symbol}
        key={symbol}
      >
        <span
          class="w-3 h-3 rounded-full flex-shrink-0"
          style={`background-color: ${colors[symbol]}`}
        ></span>

        <span
          class={
            symbol === "PORTFOLIO_AVG"
              ? "font-semibold text-gray-900"
              : "font-medium text-gray-700"
          }
        >
          {symbol === "PORTFOLIO_AVG" ? "Portfolio Avg" : symbol}
        </span>
      </div>
    ))}
  </div>
</div>

<script client:load>
  const lines = document.querySelectorAll("path[data-symbol]");
  const badges = document.querySelectorAll(".value-badge");
  const legendItems = document.querySelectorAll(".legend-item");

  let lockedSymbol = null;

  function highlight(symbol) {
    lines.forEach((line) => {
      if (line.dataset.symbol === symbol) {
        line.style.opacity = "1";
        line.style.strokeWidth = line.classList.contains("portfolio-line")
          ? "4"
          : "3";
      } else {
        line.style.opacity = "0.1";
      }
    });

    badges.forEach((badge) => {
      badge.style.display =
        badge.dataset.symbol === symbol ? "block" : "none";
    });
  }

  function reset() {
    lines.forEach((line) => {
      line.style.opacity = "";
      line.style.strokeWidth = line.classList.contains("portfolio-line")
        ? "4"
        : "2";
    });

    badges.forEach((badge) => {
      badge.style.display = "none";
    });
  }

  legendItems.forEach((item) => {
    const symbol = item.dataset.symbol;

    // Desktop hover
    item.addEventListener("mouseenter", () => {
      if (lockedSymbol) return;
      highlight(symbol);
    });

    item.addEventListener("mouseleave", () => {
      if (lockedSymbol) return;
      reset();
    });

    // Mobile touch
    item.addEventListener("touchstart", (e) => {
      e.preventDefault();

      if (lockedSymbol === symbol) {
        lockedSymbol = null;
        reset();
      } else {
        lockedSymbol = symbol;
        highlight(symbol);
      }
    });
  });

  // Tap outside to clear (mobile)
  document.addEventListener("touchstart", (e) => {
    if (!e.target.closest(".legend-item")) {
      lockedSymbol = null;
      reset();
    }
  });
</script>