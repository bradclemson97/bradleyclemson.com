---
import { siteConfig } from "../config.ts";
import PortfolioSvgChart from "../components/PortfolioSvgChart.astro";
import portfolioData from "../data/portfolioMonthly.json";

const education = siteConfig.education ?? [];
const hasEducation = education.length > 0;

// === Portfolio stats ===
const latest = portfolioData.at(-1);

let totalReturn = 0;
let topStock = "";
let topStockGain = -Infinity;

if (latest) {
  totalReturn = latest["PORTFOLIO_AVG"] ?? 0;

  for (const [key, value] of Object.entries(latest)) {
    if (key !== "date" && key !== "PORTFOLIO_AVG") {
      if (value > topStockGain) {
        topStockGain = value;
        topStock = key;
      }
    }
  }
}

// === Average annual return (CAGR) ===
let avgAnnualReturn = 0;

if (portfolioData.length > 1) {
  const months = portfolioData.length - 1;
  const years = months / 12;

  const endingValue = 1 + totalReturn / 100;

  avgAnnualReturn =
    years > 0
      ? (Math.pow(endingValue, 1 / years) - 1) * 100
      : 0;
}

---

{hasEducation && (
<section id="education" class="p-8 sm:p-12 md:p-16 lg:p-24">
  <div>
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-16 items-start">
      <div class="lg:col-span-4">
        <h2 class="text-3xl sm:text-4xl md:text-5xl xl:text-7xl font-bold text-gray-900">
          Investments
        </h2>
        <div class="w-[75px] h-[5px] mt-2 rounded-full" style={`background-color: ${siteConfig.accentColor}`} />
      </div>

      <div class="lg:col-span-8 space-y-8">
        {education.map((edu, index) => (
          <div key={index} class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-5 md:p-6 hover:shadow-md transition-shadow duration-300">
            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between mb-4">
              <div>
                <h3 class="text-lg sm:text-xl font-semibold text-gray-900">{edu.degree}</h3>
                <p class="text-base sm:text-lg" style={`color: ${siteConfig.accentColor}`}>{edu.school}</p>
              </div>
              <span class="text-xs sm:text-sm text-gray-500 mt-2 sm:mt-0">{edu.dateRange}</span>
            </div>

            {edu.achievements && (
              <ul class="space-y-2">
                {edu.achievements.map((achievement, achIndex) => (
                  <li key={achIndex} class="flex items-start">
                    <span class="inline-block w-1.5 h-1.5 rounded-full bg-gray-400 mt-2 mr-3 flex-shrink-0" />
                    <span class="text-sm sm:text-base text-gray-600">{achievement}</span>
                  </li>
                ))}
              </ul>
            )}
          </div>
        ))}

        {/* Portfolio Stats */}
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="bg-white rounded-lg border border-gray-100 p-4">
            <p class="text-xs uppercase tracking-wide text-gray-500">
              Total Return
            </p>
            <p class="text-2xl font-semibold text-gray-900 mt-1">
              {totalReturn.toFixed(2)}%
            </p>
            <p class="text-xs text-gray-500 mt-1">
              Since Jan 2024
            </p>
          </div>

          <div class="bg-white rounded-lg border border-gray-100 p-4">
            <p class="text-xs uppercase tracking-wide text-gray-500">
              Top Stock
            </p>
            <p class="text-2xl font-semibold text-gray-900 mt-1">
              {topStock}
            </p>
            <p class="text-xs text-gray-500 mt-1">
              Best performer
            </p>
          </div>

          <div class="bg-white rounded-lg border border-gray-100 p-4">
            <p class="text-xs uppercase tracking-wide text-gray-500">
              Avg Annual Return
            </p>
            <p
              class="text-2xl font-semibold mt-1"
              class:list={{
                "text-green-600": avgAnnualReturn >= 0,
                "text-red-600": avgAnnualReturn < 0,
              }}
            >
              {avgAnnualReturn.toFixed(2)}%
            </p>
            <p class="text-xs text-gray-500 mt-1">
              Annualised (CAGR)
            </p>
          </div>
        </div>

        {/* Portfolio Chart */}
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-5 md:p-6">
          <h3 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4">Portfolio Performance</h3>
          <PortfolioSvgChart data={portfolioData} />
          <p class="text-xs text-gray-500 mt-3 max-w-xl">
            Relative price performance since January 2024 using monthly adjusted close data.
          </p>
        </div>
      </div>
    </div>
  </div>
</section>
)}
